# ChiBank/QRPay 操作文档

## 目录

1. [系统概述](#系统概述)
2. [系统要求](#系统要求)
3. [安装指南](#安装指南)
4. [配置指南](#配置指南)
5. [用户操作手册](#用户操作手册)
6. [管理员操作手册](#管理员操作手册)
7. [API 文档](#api-文档)
8. [常见问题](#常见问题)
9. [故障排除](#故障排除)

---

## 系统概述

ChiBank/QRPay 是一个基于 Laravel 框架开发的全功能支付网关系统，支持多种支付方式和用户角色。

### 主要功能

- **多角色支持**: 用户、代理、商户、管理员
- **多种支付方式**: 
  - Stripe
  - PayPal
  - Flutterwave
  - SSLCommerz
  - Perfect Money
  - Paytm
- **充值和提现**: 完整的资金管理流程
- **支付链接**: 商户和用户可以创建和分享支付链接
- **手机充值**: 支持手机话费充值
- **双因素认证**: Google 2FA 支持
- **多语言支持**: 国际化功能
- **移动应用**: Flutter 开发的移动客户端

---

## 系统要求

### 服务器要求

- **Web 服务器**: Apache/Nginx
- **PHP 版本**: >= 8.0.2
- **数据库**: MySQL 5.7+ 或 MariaDB 10.3+
- **扩展**:
  - OpenSSL PHP Extension
  - PDO PHP Extension
  - Mbstring PHP Extension
  - Tokenizer PHP Extension
  - XML PHP Extension
  - Ctype PHP Extension
  - JSON PHP Extension
  - BCMath PHP Extension
  - GD Library
  - Fileinfo Extension

### 推荐配置

- **内存**: 最少 2GB RAM
- **存储**: 最少 10GB 可用空间
- **CPU**: 2 核心或以上

---

## 安装指南

### 步骤 1: 下载源代码

```bash
git clone https://github.com/LILIANSRL/chibank-.git
cd chibank-
```

### 步骤 2: 安装依赖

```bash
composer install
npm install
```

### 步骤 3: 环境配置

```bash
cp .env.example .env
php artisan key:generate
```

### 步骤 4: 数据库配置

编辑 `.env` 文件，配置数据库连接：

```env
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=your_database_name
DB_USERNAME=your_username
DB_PASSWORD=your_password
```

### 步骤 5: 运行迁移

```bash
php artisan migrate
php artisan db:seed
```

### 步骤 6: 创建存储链接

```bash
php artisan storage:link
```

### 步骤 7: 编译资源

```bash
npm run build
```

### 步骤 8: 启动应用

```bash
php artisan serve
```

访问 `http://localhost:8000` 查看应用。

---

## 配置指南

### 基础配置

#### 应用配置

在 `.env` 文件中设置：

```env
APP_NAME="ChiBank"
APP_ENV=production
APP_DEBUG=false
APP_URL=https://your-domain.com
APP_MODE=live
```

#### 邮件配置

```env
MAIL_MAILER=smtp
MAIL_HOST=smtp.example.com
MAIL_PORT=587
MAIL_USERNAME=your-email@example.com
MAIL_PASSWORD=your-password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=noreply@example.com
MAIL_FROM_NAME="${APP_NAME}"
```

### 支付网关配置

#### Stripe 配置

1. 登录管理后台
2. 进入 **设置 > 支付网关 > Stripe**
3. 输入 API 密钥：
   - Publishable Key
   - Secret Key
4. 保存配置

#### PayPal 配置

1. 进入 **设置 > 支付网关 > PayPal**
2. 输入：
   - Client ID
   - Secret
   - 模式（沙箱/生产）
3. 保存配置

#### SSLCommerz 配置

1. 进入 **设置 > 支付网关 > SSLCommerz**
2. 输入：
   - Store ID
   - Store Password
3. 保存配置

### 缓存和队列配置

#### 缓存配置

```bash
# 清除配置缓存
php artisan config:clear

# 缓存配置
php artisan config:cache

# 清除路由缓存
php artisan route:clear

# 缓存路由
php artisan route:cache
```

#### 队列配置

```env
QUEUE_CONNECTION=database
```

启动队列处理器：

```bash
php artisan queue:work
```

---

## 用户操作手册

### 注册和登录

#### 注册新账户

1. 访问注册页面
2. 填写必要信息：
   - 邮箱
   - 密码
   - 确认密码
   - 其他个人信息
3. 接受条款和条件
4. 点击"注册"
5. 验证邮箱

#### 登录

1. 访问登录页面
2. 输入邮箱和密码
3. 如果启用了 2FA，输入验证码
4. 点击"登录"

### 账户管理

#### 个人资料设置

1. 登录账户
2. 进入 **个人资料**
3. 更新个人信息
4. 上传头像
5. 保存更改

#### 安全设置

1. 进入 **安全设置**
2. 启用双因素认证（2FA）
3. 修改密码
4. 查看登录历史

### 充值操作

#### 使用支付网关充值

1. 进入 **充值** 页面
2. 选择支付网关
3. 输入金额
4. 点击"继续"
5. 在支付网关页面完成支付
6. 等待确认

#### 手动充值

1. 进入 **充值** 页面
2. 选择"手动支付"
3. 按照说明转账
4. 上传支付凭证
5. 等待管理员审核

### 提现操作

1. 进入 **提现** 页面
2. 选择提现方式
3. 输入金额
4. 输入提现账户信息
5. 提交申请
6. 等待处理

### 支付链接

#### 创建支付链接

1. 进入 **支付链接**
2. 点击"创建新链接"
3. 设置：
   - 标题
   - 金额
   - 货币
   - 有效期
4. 生成链接
5. 分享链接

#### 管理支付链接

1. 查看所有支付链接
2. 查看支付状态
3. 删除或禁用链接

### 交易历史

1. 进入 **交易历史**
2. 查看所有交易记录
3. 使用筛选器：
   - 日期范围
   - 交易类型
   - 状态
4. 导出交易报告

---

## 管理员操作手册

### 仪表板

管理员仪表板显示：
- 总用户数
- 总交易量
- 今日收入
- 待处理请求
- 系统健康状态

### 用户管理

#### 查看用户

1. 进入 **用户管理**
2. 查看所有用户列表
3. 使用搜索和筛选功能

#### 编辑用户

1. 选择用户
2. 编辑用户信息
3. 调整用户余额
4. 设置用户状态（活跃/禁用）
5. 保存更改

#### 用户验证

1. 进入 **KYC 验证**
2. 查看待审核文件
3. 批准或拒绝验证
4. 添加备注

### 交易管理

#### 查看交易

1. 进入 **交易管理**
2. 查看所有交易
3. 查看交易详情
4. 导出报告

#### 处理提现请求

1. 进入 **提现请求**
2. 查看待处理请求
3. 验证请求详情
4. 批准或拒绝
5. 添加处理备注

### 支付网关管理

#### 配置支付网关

1. 进入 **支付网关设置**
2. 选择支付网关
3. 启用/禁用网关
4. 配置 API 密钥
5. 设置手续费
6. 保存配置

#### 测试支付网关

1. 在沙箱模式下测试
2. 进行测试交易
3. 验证回调
4. 检查日志

### 系统设置

#### 基本设置

1. 进入 **系统设置**
2. 配置：
   - 网站名称
   - Logo
   - 联系信息
   - 时区
   - 货币
3. 保存设置

#### 邮件模板

1. 进入 **邮件模板**
2. 编辑模板：
   - 欢迎邮件
   - 交易确认
   - 提现通知
3. 使用变量占位符
4. 预览和保存

#### 费用设置

1. 进入 **费用设置**
2. 设置：
   - 充值手续费
   - 提现手续费
   - 转账手续费
3. 按百分比或固定金额
4. 保存配置

### 报告和分析

#### 生成报告

1. 进入 **报告**
2. 选择报告类型：
   - 财务报告
   - 用户报告
   - 交易报告
3. 设置日期范围
4. 生成并导出

#### 查看分析

1. 进入 **分析**
2. 查看图表：
   - 收入趋势
   - 用户增长
   - 交易量
3. 使用筛选器

---

## API 文档

### 认证

所有 API 请求需要认证。使用 Laravel Passport OAuth2。

#### 获取访问令牌

**端点**: `POST /api/access-token`

**请求体**:
```json
{
  "email": "user@example.com",
  "password": "password123"
}
```

**响应**:
```json
{
  "status": true,
  "message": "Login Successful",
  "data": {
    "access_token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
    "token_type": "Bearer",
    "expires_at": "2025-12-18 05:07:38"
  }
}
```

### 用户端点

#### 获取用户资料

**端点**: `GET /api/user/profile`

**Headers**:
```
Authorization: Bearer {access_token}
```

**响应**:
```json
{
  "status": true,
  "data": {
    "user": {
      "id": 1,
      "firstname": "John",
      "lastname": "Doe",
      "email": "john@example.com",
      "balance": 1000.00
    }
  }
}
```

#### 充值

**端点**: `POST /api/add-money/submit`

**Headers**:
```
Authorization: Bearer {access_token}
```

**请求体**:
```json
{
  "gateway": "stripe",
  "amount": 100.00,
  "currency": "USD"
}
```

### 支付链接端点

#### 创建支付链接

**端点**: `POST /api/payment-link/create`

**Headers**:
```
Authorization: Bearer {access_token}
```

**请求体**:
```json
{
  "title": "Product Payment",
  "amount": 50.00,
  "currency": "USD",
  "limit": 10
}
```

### 错误代码

| 代码 | 说明 |
|------|------|
| 200  | 成功 |
| 400  | 错误请求 |
| 401  | 未授权 |
| 403  | 禁止访问 |
| 404  | 未找到 |
| 422  | 验证错误 |
| 500  | 服务器错误 |

---

## 常见问题

### 1. 如何重置密码？

点击登录页面的"忘记密码"链接，输入邮箱，按照邮件中的说明重置密码。

### 2. 支持哪些支付网关？

系统支持 Stripe, PayPal, Flutterwave, SSLCommerz, Perfect Money, Paytm 等多种支付网关。

### 3. 手续费如何计算？

手续费由管理员在后台设置，可以是固定金额或交易金额的百分比。

### 4. 提现需要多长时间处理？

通常在 24-48 小时内处理，具体取决于管理员审核和支付网关处理速度。

### 5. 如何启用双因素认证？

进入个人资料的安全设置，扫描 QR 码，输入验证码即可启用。

### 6. 移动应用在哪里下载？

移动应用源代码在 `qrpay-user-app` 目录中，需要自行编译发布。

---

## 故障排除

### 支付失败

**可能原因**:
1. 支付网关配置错误
2. API 密钥过期
3. 余额不足
4. 网络连接问题

**解决方案**:
1. 检查支付网关配置
2. 更新 API 密钥
3. 确认账户余额
4. 检查网络连接
5. 查看日志文件

### 邮件发送失败

**可能原因**:
1. SMTP 配置错误
2. 邮件服务器问题
3. 防火墙阻止

**解决方案**:
1. 验证 `.env` 中的 SMTP 设置
2. 测试邮件服务器连接
3. 检查防火墙设置
4. 查看 `storage/logs` 日志

### 页面加载缓慢

**解决方案**:
1. 启用缓存：
   ```bash
   php artisan config:cache
   php artisan route:cache
   php artisan view:cache
   ```
2. 优化数据库查询
3. 使用 Redis 缓存
4. 启用 CDN

### 数据库连接错误

**解决方案**:
1. 检查 `.env` 数据库配置
2. 确认数据库服务运行
3. 验证用户权限
4. 检查防火墙规则

### 权限问题

**解决方案**:
```bash
# 设置正确的权限
sudo chown -R www-data:www-data storage bootstrap/cache
sudo chmod -R 775 storage bootstrap/cache
```

---

## 技术支持

如需更多帮助，请联系：

- **邮箱**: support@chibank.com
- **文档**: https://chibank.com/docs
- **社区论坛**: https://forum.chibank.com

---

**版本**: 5.0.0  
**最后更新**: 2025年11月18日
